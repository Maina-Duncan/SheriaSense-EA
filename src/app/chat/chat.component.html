<div class="chat-layout">
  
  <header class="chat-header">
    <div class="left">
      <a routerLink="/" class="back-btn">â† {{ isSwahili ? 'Nyuma' : 'Back' }}</a>
      
      <div class="header-content">
        <h2>SheriaSense</h2>
        
        <div class="country-switcher">
          <button *ngFor="let c of countries" (click)="switchCountry(c.name)" [class.active]="geminiService.selectedCountry === c.name">
            <img [src]="c.flag" alt="{{ c.name }}">
          </button>
        </div>

        <div class="lang-toggle">
          <label class="switch">
            <input type="checkbox" [(ngModel)]="isSwahili" (change)="updateUI()">
            <span class="slider round"></span>
          </label>
          <span class="lang-label">Swahili</span>
        </div>
      </div>
    </div>
  </header>

  <div *ngIf="showSafetyWarning" class="safety-banner">
    âš ï¸ <strong>{{ isSwahili ? 'Dharura?' : 'Emergency?' }}</strong> {{ isSwahili ? 'Ikiwa uko hatarini, piga 999.' : 'If in immediate danger, call 999.' }}
  </div>

  <div class="messages-container" #scrollContainer>
    <div *ngFor="let msg of chatHistory; let i = index" [class]="'message-row ' + msg.role">
      <div class="avatar">
        <ng-container *ngIf="msg.role === 'ai'; else userAvatar">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="16" r="2"></circle><path d="M12 11V7"></path><rect x="10" y="3" width="4" height="4"></rect></svg>
        </ng-container>
        <ng-template #userAvatar>ğŸ‘¤</ng-template>
      </div>

      <div class="content-wrapper">
        <div *ngIf="msg.attachment" class="attachment-preview">
          <span class="file-icon">ğŸ“„</span> {{ isSwahili ? 'Hati' : 'Attached Doc' }}
        </div>
        
        <div class="bubble" [innerHTML]="formatText(msg.text)"></div>
        
        <div *ngIf="msg.role === 'ai'" class="message-actions">
          <button 
            (click)="speak(msg.text, i)" 
            [class.active-speak]="speakingMessageIndex === i"
            [title]="isSwahili ? 'Soma' : 'Read Aloud'">
            {{ speakingMessageIndex === i ? (isSwahili ? 'â¹ Acha' : 'â¹ Stop') : (isSwahili ? 'ğŸ”Š Skiza' : 'ğŸ”Š Listen') }}
          </button>

          <button (click)="share(msg.text)" [title]="isSwahili ? 'Shiriki' : 'Share'">
            {{ isSwahili ? 'Shiriki â†—' : 'Share â†—' }}
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="message-row ai">
      <div class="avatar"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#333" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="16" r="2"></circle><path d="M12 11V7"></path><rect x="10" y="3" width="4" height="4"></rect></svg></div>
      <div class="bubble loading">
        <span *ngIf="!isAnalyzing">â—â—â—</span>
        <span *ngIf="isAnalyzing">ğŸ” {{ isSwahili ? 'Inachambua...' : 'Analyzing...' }}</span>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="chips-scroll" *ngIf="!isLoading && chatHistory.length < 3">
      <button *ngFor="let chip of suggestionChips" (click)="useChip(chip.text)" class="chip">{{ chip.label }}</button>
    </div>

    <div *ngIf="selectedFile" class="file-preview-bar">
      <div class="file-info"><span class="icon">ğŸ“„</span><span class="name">{{ selectedFile.name }}</span></div>
      <button (click)="clearFile()" class="remove-btn">Ã—</button>
    </div>

    <div class="input-wrapper">
      <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,application/pdf" style="display: none;">
      
      <button class="attach-btn" (click)="fileInput.click()" [title]="isSwahili ? 'Ambatanisha' : 'Attach'" [disabled]="isLoading">ğŸ“</button>

      <input 
        [(ngModel)]="userInput" 
        (keyup.enter)="sendMessage()"
        [placeholder]="isListening ? (isSwahili ? 'Inasikiliza...' : 'Listening...') : (selectedFile ? (isSwahili ? 'Uliza...' : 'Ask about this doc...') : (isSwahili ? 'Andika au ongea...' : 'Type or speak...'))" 
        [disabled]="isLoading"
      />
      
      <button class="mic-btn" (click)="toggleMic()" [class.listening]="isListening" [title]="isSwahili ? 'Ongea' : 'Speak'">
        {{ isListening ? 'â¹' : 'ğŸ™ï¸' }}
      </button>

      <button (click)="sendMessage()" [disabled]="(!userInput.trim() && !selectedFile) || isLoading">
        {{ isSwahili ? 'Tuma' : 'Send' }}
      </button>
    </div>
    <p class="disclaimer">
      {{ isSwahili ? 'Thibitisha na chanzo rasmi.' : 'Verify with an official source.' }}
    </p>
  </div>

</div>