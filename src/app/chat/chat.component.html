<div class="chat-layout">
  <header class="chat-header">
    <div class="left">
      <a routerLink="/" class="back-btn">
        <span class="material-icons">arrow_back</span> 
        <span class="back-text">Back</span>
      </a>
      
      <div class="country-switcher">
        <button [class.active]="geminiService.selectedCountry === 'Kenya'" (click)="switchCountry('Kenya')">
          <img src="https://flagcdn.com/w40/ke.png" alt="Kenya">
          <span>Kenya</span>
        </button>
        <button [class.active]="geminiService.selectedCountry === 'Uganda'" (click)="switchCountry('Uganda')">
          <img src="https://flagcdn.com/w40/ug.png" alt="Uganda">
          <span>Uganda</span>
        </button>
        <button [class.active]="geminiService.selectedCountry === 'Tanzania'" (click)="switchCountry('Tanzania')">
          <img src="https://flagcdn.com/w40/tz.png" alt="Tanzania">
          <span>Tanzania</span>
        </button>
      </div>
    </div>

    <div class="lang-toggle">
      <span class="lang-code" [class.active]="!isSwahili">EN</span>
      <label class="switch">
        <input type="checkbox" [(ngModel)]="isSwahili" (change)="updateUI()">
        <span class="slider"></span>
      </label>
      <span class="lang-code" [class.active]="isSwahili">SW</span>
    </div>
  </header>

  <div *ngIf="showSafetyWarning" class="safety-banner">
    ‚ö†Ô∏è <strong>Emergency Detected:</strong> If you are in immediate danger, please call <strong>999</strong> or the Gender Violence Helpline <strong>1195</strong>.
  </div>

  <div class="messages-container" #scrollContainer>
    <div *ngFor="let msg of chatHistory; let i = index" 
         class="message-row" 
         [ngClass]="msg.role">
      
      <div class="avatar">
        {{ msg.role === 'ai' ? '‚öñÔ∏è' : 'üë§' }}
      </div>
      
      <div class="content-wrapper">
        <div *ngIf="msg.attachment" class="attachment-preview">
           <span class="material-icons" style="font-size: 14px;">attach_file</span> Document Attached
        </div>
        
        <div class="bubble" [innerHTML]="formatText(msg.text)"></div>
        
        <div class="message-actions" *ngIf="msg.role === 'ai'">
          <button (click)="speak(msg.text, i)" [class.active-speak]="speakingMessageIndex === i">
            <span class="material-icons">{{ speakingMessageIndex === i ? 'stop' : 'volume_up' }}</span>
            {{ speakingMessageIndex === i ? 'Stop' : 'Listen' }}
          </button>
          <button (click)="share(msg.text)">
            <span class="material-icons">share</span> Share
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="message-row ai">
      <div class="avatar">‚öñÔ∏è</div>
      <div class="bubble loading">
        {{ isAnalyzing ? 'üîç Analyzing document...' : 'Thinking...' }}
      </div>
    </div>
  </div>

  <footer class="input-area">
    <div class="chips-scroll" *ngIf="chatHistory.length < 2">
      <div class="chip" *ngFor="let chip of suggestionChips" (click)="useChip(chip.text)">
        {{ chip.label }}
      </div>
    </div>

    <div *ngIf="selectedFile" class="file-preview-bar">
      <div class="file-info">
        <span class="material-icons">description</span>
        <span class="name">{{ selectedFile.name }}</span>
      </div>
      <button (click)="clearFile()" class="remove-btn">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="input-wrapper">
      <label class="attach-btn" title="Upload Document">
        <input type="file" (change)="onFileSelected($event)" hidden accept="image/*,application/pdf">
        <span class="material-icons">attach_file</span>
      </label>

      <input [(ngModel)]="userInput" 
             (keyup.enter)="sendMessage()" 
             [placeholder]="isListening ? 'Listening...' : (isSwahili ? 'Andika au sema...' : 'Type or speak...')"
             [disabled]="isLoading">

      <button class="mic-btn" (click)="toggleMic()" [class.listening]="isListening" title="Voice Input">
        <span class="material-icons">{{ isListening ? 'mic_off' : 'mic' }}</span>
      </button>

      <button class="send-btn" (click)="sendMessage()" [disabled]="isLoading || (!userInput.trim() && !selectedFile)">
        <span class="material-icons">send</span>
      </button>
    </div>

    <div class="disclaimer">
      Verify with an official source.
    </div>
  </footer>
</div>